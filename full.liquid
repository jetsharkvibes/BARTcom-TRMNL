<div class="layout layout--col gap--large">
  <!-- Header: Origin → Destination -->
  <div class="header">
    <div class="title title--large">{{ root.origin }} → {{ root.destination }}</div>
  </div>

  {% if root.schedule.request.trip %}
    {% assign trips = root.schedule.request.trip %}

    <!-- Two column layout: Large card left, three small cards right -->
    <div class="grid grid--cols-3 gap--medium">

      <!-- Left column - Summary card and first trip large card (spans 2 columns) -->
      <div class="layout layout--col gap--medium" style="grid-column: span 2;">

        <!-- Summary Card: Origin → Destination with unique routes -->
        <div class="item bg--white rounded--medium" style="padding: 20px; border: 3px solid black;">
          <div class="content layout--col gap--small">
            <div class="label label--large text--black" style="font-weight: bold;">
              {{ root.origin }} → {{ root.destination }}
            </div>

            <!-- Collect unique route combinations -->
            <div class="flex flex--row gap--medium" style="margin-top: 12px;">
              {% assign processed_routes = "" %}
              {% for trip in trips %}
                {% assign route_key = "" %}
                {% assign route_time = trip['@tripTime'] %}

                <!-- Build route key from all legs -->
                {% if trip.leg[0] %}
                  {% for leg in trip.leg %}
                    {% assign heading_lower = leg['@trainHeadStation'] | downcase %}
                    {% if heading_lower contains 'richmond' %}
                      {% assign abbreviation = 'RICH' %}
                    {% elsif heading_lower contains 'millbrae' %}
                      {% assign abbreviation = 'MLBR' %}
                    {% elsif heading_lower contains 'dublin' %}
                      {% assign abbreviation = 'DUBL' %}
                    {% elsif heading_lower contains 'berryessa' %}
                      {% assign abbreviation = 'BERY' %}
                    {% elsif heading_lower contains 'daly' %}
                      {% assign abbreviation = 'DALY' %}
                    {% elsif heading_lower contains 'antioch' %}
                      {% assign abbreviation = 'ANTC' %}
                    {% elsif heading_lower contains 'pittsburg' %}
                      {% assign abbreviation = 'PITT' %}
                    {% elsif heading_lower contains 'sfo' or heading_lower contains 'international airport' %}
                      {% assign abbreviation = 'SFIA' %}
                    {% elsif heading_lower contains 'oakland airport' %}
                      {% assign abbreviation = 'OAKL' %}
                    {% else %}
                      {% assign abbreviation = leg['@trainHeadStation'] %}
                    {% endif %}
                    {% assign route_key = route_key | append: abbreviation | append: "/" %}
                  {% endfor %}
                {% else %}
                  {% assign leg = trip.leg %}
                  {% assign heading_lower = leg['@trainHeadStation'] | downcase %}
                  {% if heading_lower contains 'richmond' %}
                    {% assign abbreviation = 'RICH' %}
                  {% elsif heading_lower contains 'millbrae' %}
                    {% assign abbreviation = 'MLBR' %}
                  {% elsif heading_lower contains 'dublin' %}
                    {% assign abbreviation = 'DUBL' %}
                  {% elsif heading_lower contains 'berryessa' %}
                    {% assign abbreviation = 'BERY' %}
                  {% elsif heading_lower contains 'daly' %}
                    {% assign abbreviation = 'DALY' %}
                  {% elsif heading_lower contains 'antioch' %}
                    {% assign abbreviation = 'ANTC' %}
                  {% elsif heading_lower contains 'pittsburg' %}
                    {% assign abbreviation = 'PITT' %}
                  {% elsif heading_lower contains 'sfo' or heading_lower contains 'international airport' %}
                    {% assign abbreviation = 'SFIA' %}
                  {% elsif heading_lower contains 'oakland airport' %}
                    {% assign abbreviation = 'OAKL' %}
                  {% else %}
                    {% assign abbreviation = leg['@trainHeadStation'] %}
                  {% endif %}
                  {% assign route_key = route_key | append: abbreviation | append: "/" %}
                {% endif %}

                <!-- Display route if not already processed -->
                {% unless processed_routes contains route_key %}
                  <div class="layout layout--col gap--small" style="padding: 12px; background: #f0f0f0; border-radius: 8px; min-width: 120px;">
                    <!-- Route badges -->
                    <div class="flex flex--wrap gap--small">
                      {% if trip.leg[0] %}
                        {% for leg in trip.leg %}
                          {% assign heading_lower = leg['@trainHeadStation'] | downcase %}
                          {% if heading_lower contains 'richmond' %}
                            {% assign abbreviation = 'RICH' %}
                          {% elsif heading_lower contains 'millbrae' %}
                            {% assign abbreviation = 'MLBR' %}
                          {% elsif heading_lower contains 'dublin' %}
                            {% assign abbreviation = 'DUBL' %}
                          {% elsif heading_lower contains 'berryessa' %}
                            {% assign abbreviation = 'BERY' %}
                          {% elsif heading_lower contains 'daly' %}
                            {% assign abbreviation = 'DALY' %}
                          {% elsif heading_lower contains 'antioch' %}
                            {% assign abbreviation = 'ANTC' %}
                          {% elsif heading_lower contains 'pittsburg' %}
                            {% assign abbreviation = 'PITT' %}
                          {% elsif heading_lower contains 'sfo' or heading_lower contains 'international airport' %}
                            {% assign abbreviation = 'SFIA' %}
                          {% elsif heading_lower contains 'oakland airport' %}
                            {% assign abbreviation = 'OAKL' %}
                          {% else %}
                            {% assign abbreviation = leg['@trainHeadStation'] %}
                          {% endif %}

                          <div class="bg--black rounded--small px--small py--small">
                            <div class="label label--xsmall text--white" style="font-weight: bold; white-space: nowrap;">
                              {{ abbreviation }}
                            </div>
                          </div>
                        {% endfor %}
                      {% else %}
                        {% assign leg = trip.leg %}
                        {% assign heading_lower = leg['@trainHeadStation'] | downcase %}
                        {% if heading_lower contains 'richmond' %}
                          {% assign abbreviation = 'RICH' %}
                        {% elsif heading_lower contains 'millbrae' %}
                          {% assign abbreviation = 'MLBR' %}
                        {% elsif heading_lower contains 'dublin' %}
                          {% assign abbreviation = 'DUBL' %}
                        {% elsif heading_lower contains 'berryessa' %}
                          {% assign abbreviation = 'BERY' %}
                        {% elsif heading_lower contains 'daly' %}
                          {% assign abbreviation = 'DALY' %}
                        {% elsif heading_lower contains 'antioch' %}
                          {% assign abbreviation = 'ANTC' %}
                        {% elsif heading_lower contains 'pittsburg' %}
                          {% assign abbreviation = 'PITT' %}
                        {% elsif heading_lower contains 'sfo' or heading_lower contains 'international airport' %}
                          {% assign abbreviation = 'SFIA' %}
                        {% elsif heading_lower contains 'oakland airport' %}
                          {% assign abbreviation = 'OAKL' %}
                        {% else %}
                          {% assign abbreviation = leg['@trainHeadStation'] %}
                        {% endif %}

                        <div class="bg--black rounded--small px--small py--small">
                          <div class="label label--xsmall text--white" style="font-weight: bold; white-space: nowrap;">
                            {{ abbreviation }}
                          </div>
                        </div>
                      {% endif %}
                    </div>

                    <!-- Travel time -->
                    <div class="label label--small text--black" style="font-weight: bold; margin-top: 4px;">
                      {{ route_time }} min
                    </div>
                  </div>
                  {% assign processed_routes = processed_routes | append: route_key | append: "," %}
                {% endunless %}
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- First trip large card -->
        {% assign first_trip = trips[0] %}
        {% if first_trip %}
        <div class="item bg--black rounded--medium" style="padding: 20px;">
          <div class="content layout--col gap--medium">
            <!-- Train Line Badges -->
            <div class="flex flex--wrap gap--small mb--medium">
              {% if first_trip.leg[0] %}
                {% assign leg_count = 0 %}
                {% for leg in first_trip.leg %}
                  {% assign heading_lower = leg['@trainHeadStation'] | downcase %}
                  {% if heading_lower contains 'richmond' %}
                    {% assign abbreviation = 'RICH' %}
                  {% elsif heading_lower contains 'millbrae' %}
                    {% assign abbreviation = 'MLBR' %}
                  {% elsif heading_lower contains 'dublin' %}
                    {% assign abbreviation = 'DUBL' %}
                  {% elsif heading_lower contains 'berryessa' %}
                    {% assign abbreviation = 'BERY' %}
                  {% elsif heading_lower contains 'daly' %}
                    {% assign abbreviation = 'DALY' %}
                  {% elsif heading_lower contains 'antioch' %}
                    {% assign abbreviation = 'ANTC' %}
                  {% elsif heading_lower contains 'pittsburg' %}
                    {% assign abbreviation = 'PITT' %}
                  {% elsif heading_lower contains 'sfo' or heading_lower contains 'international airport' %}
                    {% assign abbreviation = 'SFIA' %}
                  {% elsif heading_lower contains 'oakland airport' %}
                    {% assign abbreviation = 'OAKL' %}
                  {% else %}
                    {% assign abbreviation = leg['@trainHeadStation'] %}
                  {% endif %}

                  {% if abbreviation and leg_count < 2 %}
                    <div class="bg--white rounded--small px--medium py--medium">
                      <div class="label label--large text--black label--outline" style="font-weight: bold; white-space: nowrap;">
                      {{ abbreviation }}
                      </div>
                    </div>
                    {% assign leg_count = leg_count | plus: 1 %}
                  {% endif %}
                {% endfor %}
              {% else %}
                {% assign leg = first_trip.leg %}
                {% assign heading_lower = leg['@trainHeadStation'] | downcase %}
                {% if heading_lower contains 'richmond' %}
                  {% assign abbreviation = 'RICH' %}
                {% elsif heading_lower contains 'millbrae' %}
                  {% assign abbreviation = 'MLBR' %}
                {% elsif heading_lower contains 'dublin' %}
                  {% assign abbreviation = 'DUBL' %}
                {% elsif heading_lower contains 'berryessa' %}
                  {% assign abbreviation = 'BERY' %}
                {% elsif heading_lower contains 'daly' %}
                  {% assign abbreviation = 'DALY' %}
                {% elsif heading_lower contains 'antioch' %}
                  {% assign abbreviation = 'ANTC' %}
                {% elsif heading_lower contains 'pittsburg' %}
                  {% assign abbreviation = 'PITT' %}
                {% elsif heading_lower contains 'sfo' or heading_lower contains 'international airport' %}
                  {% assign abbreviation = 'SFIA' %}
                {% elsif heading_lower contains 'oakland airport' %}
                  {% assign abbreviation = 'OAKL' %}
                {% else %}
                  {% assign abbreviation = leg['@trainHeadStation'] %}
                {% endif %}
                <div class="bg--white rounded--small px--medium py--medium">
                  <div class="label label--large text--black label--outline" style="font-weight: bold; white-space: nowrap;">
                     {{ abbreviation }}
                  </div>
                </div>
              {% endif %}
            </div>

            <div class="value value--xlarge text--white" style="white-space: nowrap;">
              {{ first_trip['@origTimeMin'] }}
            </div>
            <div class="label label--medium text--white">DEPART</div>
            <div class="divider"></div>
            <div class="label label--medium text--white">ARRIVE {{ first_trip['@destTimeMin'] }}</div>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Right column - Three small cards stacked vertically -->
      <div class="layout layout--col gap--medium" style="grid-column: span 1;">
        {% for trip in trips offset:1 limit:3 %}
          <div class="item bg--black rounded--medium" style="padding: 10px;">
            <div class="content layout--col gap--small">
              <!-- Train Line Badges -->
              <div class="flex flex--wrap gap--small mb--small">
                {% if trip.leg[0] %}
                  {% assign leg_count = 0 %}
                  {% for leg in trip.leg %}
                    {% assign heading_lower = leg['@trainHeadStation'] | downcase %}
                    {% if heading_lower contains 'richmond' %}
                      {% assign abbreviation = 'RICH' %}
                    {% elsif heading_lower contains 'millbrae' %}
                      {% assign abbreviation = 'MLBR' %}
                    {% elsif heading_lower contains 'dublin' %}
                      {% assign abbreviation = 'DUBL' %}
                    {% elsif heading_lower contains 'berryessa' %}
                      {% assign abbreviation = 'BERY' %}
                    {% elsif heading_lower contains 'daly' %}
                      {% assign abbreviation = 'DALY' %}
                    {% elsif heading_lower contains 'antioch' %}
                      {% assign abbreviation = 'ANTC' %}
                    {% elsif heading_lower contains 'pittsburg' %}
                      {% assign abbreviation = 'PITT' %}
                    {% elsif heading_lower contains 'sfo' or heading_lower contains 'international airport' %}
                      {% assign abbreviation = 'SFIA' %}
                    {% elsif heading_lower contains 'oakland airport' %}
                      {% assign abbreviation = 'OAKL' %}
                    {% else %}
                      {% assign abbreviation = leg['@trainHeadStation'] %}
                    {% endif %}

                    {% if abbreviation and leg_count < 2 %}
                      <div class="bg--white rounded--small px--small py--small">
                        <div class="label label--xsmall text--black label--outline" style="font-weight: bold; white-space: nowrap;">
                        {{ abbreviation }}
                        </div>
                      </div>
                      {% assign leg_count = leg_count | plus: 1 %}
                    {% endif %}
                  {% endfor %}
                {% else %}
                  {% assign leg = trip.leg %}
                  {% assign heading_lower = leg['@trainHeadStation'] | downcase %}
                  {% if heading_lower contains 'richmond' %}
                    {% assign abbreviation = 'RICH' %}
                  {% elsif heading_lower contains 'millbrae' %}
                    {% assign abbreviation = 'MLBR' %}
                  {% elsif heading_lower contains 'dublin' %}
                    {% assign abbreviation = 'DUBL' %}
                  {% elsif heading_lower contains 'berryessa' %}
                    {% assign abbreviation = 'BERY' %}
                  {% elsif heading_lower contains 'daly' %}
                    {% assign abbreviation = 'DALY' %}
                  {% elsif heading_lower contains 'antioch' %}
                    {% assign abbreviation = 'ANTC' %}
                  {% elsif heading_lower contains 'pittsburg' %}
                    {% assign abbreviation = 'PITT' %}
                  {% elsif heading_lower contains 'sfo' or heading_lower contains 'international airport' %}
                    {% assign abbreviation = 'SFIA' %}
                  {% elsif heading_lower contains 'oakland airport' %}
                    {% assign abbreviation = 'OAKL' %}
                  {% else %}
                    {% assign abbreviation = leg['@trainHeadStation'] %}
                  {% endif %}
                  <div class="bg--white rounded--small px--small py--small">
                    <div class="label label--xsmall text--black label--outline" style="font-weight: bold; white-space: nowrap;">
                       {{ abbreviation }}
                    </div>
                  </div>
                {% endif %}
              </div>

              <div class="value value--small text--white" style="white-space: nowrap;">
                {{ trip['@origTimeMin'] }}
              </div>
              <div class="label label--xsmall text--white">DEPART</div>
              <div class="divider"></div>
              <div class="label label--xsmall text--white">ARRIVE {{ trip['@destTimeMin'] }}</div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% else %}
    <!-- Error State: No data -->
    <div class="item">
      <div class="content layout--col gap--small">
        <div class="value value--xlarge">⚠️</div>
        <div class="label label--small">No schedule available</div>
        {% if root.message.error %}
          <div class="label label--xsmall">{{ root.message.error.text }}</div>
        {% endif %}
      </div>
    </div>
  {% endif %}

  <div class="footer">
    <div class="divider"></div>
    <div class="label label--xsmall">Real-time BART schedule</div>
  </div>
</div>
